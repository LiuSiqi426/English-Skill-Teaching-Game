<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English QA Game - English Skill Teaching Game</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Silkscreen&display=swap" rel="stylesheet">
    <script src="game-data.js"></script>
</head>
<body>
    <div id="app"></div>
    
    <script>
        let currentScene = '';
        let currentQuestion = 0;
        let score = 0;
        let questions = [];
        
        function showSceneSelection() {
            const app = document.getElementById('app');
            app.innerHTML = `
                <div class="game-container">
                    <header class="game-header">
                        <h1>üéÆ English Conversation Game</h1>
                        <button id="main-menu-btn" class="pixel-btn back-btn">‚Üê Main Menu</button>
                    </header>
                    
                    <div class="scene-selection">
                        <h2>Choose a Conversation Scenario</h2>
                        <p>Practice real-life English conversations in different settings</p>
                        
                        <div class="scenes-grid">
                            <div class="scene-card">
                                <div class="scene-icon">üçΩÔ∏è</div>
                                <h3>Restaurant Dining</h3>
                                <p>Order food, ask for recommendations, and handle restaurant situations</p>
                                <button data-scene="restaurant" class="pixel-btn play-btn">Start Practice</button>
                            </div>
                            
                            <div class="scene-card">
                                <div class="scene-icon">üè®</div>
                                <h3>Hotel Check-in</h3>
                                <p>Check in, ask for amenities, and handle hotel situations</p>
                                <button data-scene="hotel" class="pixel-btn play-btn">Start Practice</button>
                            </div>
                            
                            <div class="scene-card">
                                <div class="scene-icon">üêò</div>
                                <h3>Zoo Visit</h3>
                                <p>Ask about animals, get directions, and enjoy a zoo visit</p>
                                <button data-scene="zoo" class="pixel-btn play-btn">Start Practice</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('main-menu-btn').addEventListener('click', function() {
                window.location.href = '../../index.html';
            });
            
            document.querySelectorAll('.play-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const scene = this.getAttribute('data-scene');
                    startGame(scene);
                });
            });
        }
        
        async function startGame(scene) {
            currentScene = scene;
            currentQuestion = 0;
            score = 0;
            
            const data = getGameData(scene);
            
            if (data.success) {
                questions = data.data.questions;
                showQuestion();
            } else {
                alert('Failed to load game data.');
                showSceneSelection();
            }
        }
        
        function showQuestion() {
            const app = document.getElementById('app');
            const question = questions[currentQuestion];
            
            if (!question) {
                showResults();
                return;
            }
            
            app.innerHTML = `
                <div class="game-container">
                    <header class="game-header">
                        <h1>${getSceneTitle(currentScene)}</h1>
                        <div class="score-display">Score: ${score}/100</div>
                        <button id="back-to-scenes-btn" class="pixel-btn back-btn">‚Üê Back to Scenes</button>
                    </header>
                    
                    <div class="progress-container">
                        <div class="progress-text">
                            Question ${currentQuestion + 1} of ${questions.length}
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${((currentQuestion + 1) / questions.length) * 100}%"></div>
                        </div>
                    </div>
                    
                    <div class="question-container">
                        <div class="speaker">
                            <span class="speaker-icon">${getSpeakerIcon(question.speaker)}</span>
                            <span class="speaker-name">${question.speaker}</span>
                        </div>
                        
                        <div class="question-text">
                            ${question.text}
                        </div>
                        
                        <div class="options-container" id="options-container">
                            ${question.options.map(option => `
                                <div class="option" data-option="${option.id}" data-correct="${option.correct}">
                                    <span class="option-letter">${option.id}</span>
                                    <span class="option-text">${option.text}</span>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="next-btn-container">
                            <button id="next-btn" class="pixel-btn next-btn" disabled>
                                ${currentQuestion === questions.length - 1 ? 'Finish Game ‚Üí' : 'Next Question ‚Üí'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('back-to-scenes-btn').addEventListener('click', function() {
                showSceneSelection();
            });
            
            document.getElementById('next-btn').addEventListener('click', function() {
                nextQuestion();
            });
            
            document.querySelectorAll('.option').forEach(option => {
                option.addEventListener('click', function() {
                    const optionId = this.getAttribute('data-option');
                    const isCorrect = this.getAttribute('data-correct') === 'true';
                    selectOption(optionId, isCorrect);
                });
            });
        }
        
        async function selectOption(optionId, isCorrect) {
            const optionsContainer = document.getElementById('options-container');
            const nextBtn = document.getElementById('next-btn');
            
            if (!optionsContainer || !nextBtn) return;
            
            const allOptions = optionsContainer.querySelectorAll('.option');
            allOptions.forEach(opt => {
                opt.style.pointerEvents = 'none';
                const optId = opt.getAttribute('data-option');
                
                if (optId === optionId) {
                    opt.classList.add(isCorrect ? 'correct' : 'wrong');
                }
            });
            
            if (isCorrect) {
                score += 10;
                const scoreDisplay = document.querySelector('.score-display');
                if (scoreDisplay) {
                    scoreDisplay.textContent = `Score: ${score}/100`;
                }
            }
            
            nextBtn.disabled = false;
            
            await submitAnswerLocal(currentScene, currentQuestion + 1, optionId);
        }
        
        function nextQuestion() {
            currentQuestion++;
            if (currentQuestion < questions.length) {
                showQuestion();
            } else {
                showResults();
            }
        }
        
        async function showResults() {
            const app = document.getElementById('app');
            
            const result = await calculateResultLocal(score, questions.length);
            
            app.innerHTML = `
                <div class="game-container">
                    <header class="game-header">
                        <h1>Game Completed! üéâ</h1>
                        <button id="results-back-btn" class="pixel-btn back-btn">‚Üê Back to Scenes</button>
                    </header>
                    
                    <div class="results-container">
                        <div class="score-circle">
                            <div class="score-number">${score}</div>
                            <div class="score-total">/100</div>
                        </div>
                        
                        <div class="results-message">
                            <h2>${result.data?.message || 'Great job!'}</h2>
                            <p>You answered ${Math.floor(score/10)} out of ${questions.length} questions correctly!</p>
                        </div>
                        
                        <div class="star-rating">
                            ${[1, 2, 3].map(star => `
                                <div class="star ${star <= (result.data?.stars || 0) ? 'active' : 'inactive'}">‚≠ê</div>
                            `).join('')}
                        </div>
                        
                        <div class="results-stats">
                            <div class="stat">
                                <div class="stat-value">${Math.floor(score/10)}</div>
                                <div class="stat-label">Correct</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${questions.length - Math.floor(score/10)}</div>
                                <div class="stat-label">Incorrect</div>
                            </div>
                            <div class="stat">
                                <div class="stat-value">${questions.length}</div>
                                <div class="stat-label">Total</div>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button id="play-again-btn" class="pixel-btn play-again-btn">Play Again</button>
                            <button id="choose-another-btn" class="pixel-btn back-to-scenes-btn">Choose Another Scene</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('results-back-btn').addEventListener('click', function() {
                showSceneSelection();
            });
            
            document.getElementById('play-again-btn').addEventListener('click', function() {
                startGame(currentScene);
            });
            
            document.getElementById('choose-another-btn').addEventListener('click', function() {
                showSceneSelection();
            });
        }
        
        function getSceneTitle(scene) {
            const titles = {
                'restaurant': 'Restaurant Dining',
                'hotel': 'Hotel Check-in & Check-out',
                'zoo': 'Zoo Visit'
            };
            return titles[scene] || 'English Conversation';
        }
        
        function getSpeakerIcon(speaker) {
            const icons = {
                'Waiter': 'üçΩÔ∏è',
                'Receptionist': 'üè®',
                'Ticket Seller': 'üé´',
                'Zoo Guide': 'üêò',
                'Zoo Staff': 'üë®‚Äçüíº',
                'Parent': 'üë®‚Äçüë©‚Äçüëß',
                'Child': 'üëß',
                'Friend': 'üë´'
            };
            return icons[speaker] || 'üí¨';
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            showSceneSelection();
        });
    </script>
</body>
</html>